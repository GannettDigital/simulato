<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.min.js"></script>

<!-- Load the sankey.js function -->
<script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/sankey.js"></script>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>



<!-- Add style to links or they won't appear properly-->
<style>
    .link {
        fill: none;
        stroke: rgb(0, 0, 0);
        stroke-opacity: .2;
    }

    .link:hover {
        stroke-opacity: .5;
    }
</style>

<script>

    //init where your data is located and your auth token
    let fP;
    let aT;

    function loadFile(filePath, authToken) {
        let result = null;
        let xmlhttp = new XMLHttpRequest();
        xmlhttp.open("GET", filePath, false);
        xmlhttp.setRequestHeader("Authorization", "Bearer " + authToken)
        xmlhttp.send();
        if (xmlhttp.status == 200) {
            result = xmlhttp.responseText;
        }
        return result;
    }

    // load the data, pass 
    const graph = JSON.parse(loadFile(fP, aT));

    var margin;
    var svg;
    var color
    var sankey;
    var link;
    var node;

    let i = 0;

    function initSVG() {

        i++;
        // set the dimensions and margins of the graph
        margin = { top: 10, right: 10, bottom: 10, left: 10 },
            width = 2000,
            height = 1000;

        // append the svg object to the body of the page
        svg = d3.select("#my_dataviz").append("svg")
            .attr("id", 'currentGraph')
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        // Color scale used
        color = d3.scaleOrdinal(d3.schemeCategory20);

        // Set the sankey diagram properties
        sankey = d3.sankey()
            .nodeWidth(0)
            .nodePadding(250)
            .size([width, height]);

        console.log(i);
    }

    initSVG();
    constructSankey();
    buildSankey();

    function constructSankey() {
        sankey
            .nodes(graph.nodes)
            .links(graph.links)
            .layout(1);
    }

    function buildSankey() {
        addLinks();
        addNodes();
        addRectangles();
        addTitles();
    }

    function addLinks() {
        link = svg.append("g")
            .selectAll(".link")
            .data(graph.links)
            .enter()
            .append("path")
            .attr("class", "link")
            .attr("d", sankey.link())
            .style("stroke-width", function (d) { return Math.max(1, d.dy); })
            .sort(function (a, b) { return b.dy - a.dy; });
    }

    function addNodes() {
        node = svg.append("g")
            .selectAll(".node")
            .data(graph.nodes)
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; })
            .on("click", function (d) {
                // graph.   nodes[d.node] = {};
                // graph.nodes[d.links] = {};
                d3.select("#currentGraph").remove();
                initSVG();
                constructSankey();
                buildSankey();
                console.log(graph.links);
                console.log('clicked');
            });
    }

    function addRectangles() {
        node
            .append("rect")
            .attr("height", 100)
            .attr("width", 100)
            .style("fill", function (d) { return d.color = color(d.name.replace(/ .*/, "")); })
            .style("stroke", function (d) { return d3.rgb(d.color).darker(2); })
            .append("title")
            .text(function (d) { return d.name + "\n" + "This action occured " + d.value + " times"; })
    }
    function addTitles() {
        node
            .append("text")
            .attr("x", -6)
            .attr("y", function (d) { return d.dy / 2; })
            .attr("dy", ".35em")
            .attr("text-anchor", "end")
            .attr("transform", null)
            .text(function (d) { return d.name.split('.')[1]; })
            .filter(function (d) { return d.x < width / 2; })
            .attr("x", 6 + sankey.nodeWidth())
            .attr("text-anchor", "start");
    }
</script>